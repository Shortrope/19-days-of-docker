# Learning Docker
## Overview
### Getting started
Why use
Installing
Understanding the setup
Hello world first usage

### Handling Docker Containers
Terms
getting Docker images
working w interactive container
Pull from another repo

### Building images
  image building system
  dockerfile syntax
  dockerfile build instructions
  image management
  best practices for dockerfile

### Publishing images
  Docker hub
  Pushing to docker hub
  automating build process for images
  Private repos on docker hub
  Organization and teams on Docker hub
  REST API for Docker hub

### Running Private Docker Infrastructure
  D registry use cases
  Running D registry 
  Manage D registry with D compose
  Load balancing
  Webhook notifications
  D Registry HTTP API support

## Running Services in a Container
  container networking
  container as a service
  exposing container services

### Sharing Data w Containers
  Data volume
  sharing host data
  sharing data between containers
  pitfalls

### Orchestrating Containers
  inbuilt service discovery
  linking containers
  Orchestration

### Testing w D
  testing code inside D
  Integrating D testing ito Jenkins

### Debugging Containers
  process-level isolation for D containers
  debug commands

Securing D containers
  security scenario
  immutable infrastructure
  best practics

D platform - capabilities and use cases
  Describing containers
  D technology
  use cases
 
--------------------------------------------------
## sequence

1. Install Docker
2. get images
3. ***build images
publishing images
private docker infrastructure
4. ***run services in a container: networking
5. ***sharing data
6. **Orchestrating containers
7. **Testing
8. **Debugging
9. **Securing

## 20% for 80% results
1. Install and get images
3. ***build images
4. ***run services in a container: networking
5. ***sharing data

--------------------------------------------------
Chap 1
==================================================
## 1. Install

sudo curl -sSL https://get.docker.io/ | sh
sudo wget -qO- https://get.docker.io/ | sh

docker version
  client, client API
  server, server API
docker info 
  
### client server communication
  /var/run/docker.sock
  port 2375   //not enabled by default


### First docker image
Get a docker image
docker pull hello-world

List you docker images
docker images

Run the D image
docker run hello-world

### T-Shooting
service docker status

-------------
## 2. Get images

### Docker registry
- Docker Hub (index.docker.io)
- Quay
- Google container registry
- AWS container registry

docker pull name
docker pull name:1.23   //get specific version
docker pull -a name     // get all available versions
docker pull id/name
docker pull repo.url/name

docker search name

--------------------------------------------------
Chap 2
==================================================
## Working w Containers (Chap 2)

### interactive container
Create and start an interactive container
    docker run -i -t ubuntu:16.04 /bin/bash [--name ubusvr]
-i    interactive mode
-t    pseudo Terminal assigned to the container

Detach from an interactive container
  ^p ^q

Create continer in detached mode
docker run -d ubuntu:16.04 /bin/bash

List running containers
  docker ps
  docker ps -a    //show all regardless of state

Attach to a running container
  docker attach id|name

Exit and stop the container
  exit

### Track changes inside a container
  docker diff id|name

### Controlling containers
  docker stop id|name       //gracefully shutdown
  docker start id|name
  docker start -a id|name   //start and attach
  docker restart id|name
  docker pause id|name
  docker unpause id|name

### Housekeeping
remove unused containers:
  docker run -i -t --rm ubuntu:16.04 /bin/bash      //--rm will remove the container when done
  docker rm id|name     //one at a time manually

Remove all containers not currently running
  docker rm $(docker ps -aq)
  docker container prune

### Building images from Containers
After make changes to a container run 
  docker diff id|name

Stop the running container and run:
  docker commit id|name newImageName

### Launching a container as a daemon
  docker run -d ubuntu /bin/bash -c "while true; do date; sleep 4; done"

View the output generated by the daemon container
  docker logs id|name


==========================================================
Performance

What images do I already have locally
Search for a image
Get an image
Download a specific version image
Remove an image
Run a container
  - in interactive mode
  - in daemon mode
  - detach / attach to a container
Manage containers
  - list all images
  - list all containers 
  - stop, start, restart a container
  - diff a container vs its image
  - remove a container
Create a new image from a container
Run a container in daemon mode

==========================================================



--------------------------------------------------
Chap 3
==================================================
## 3. Building Images

D's Image building system
docker build -t imagename:tagname .
docker build -t imagename:tagname Dockerfile

### Dockerfile syntax
```
# Comment
INSTRUCTION arguments
```
- a comment # must be the first char on the line. no preceeding wht space

Dockerfile build instructions
  FROM ubuntu:16.04
  MAINTAINER Mario Kaack <mkaack@hotmail.com>
  COPY src dst
  - copy a directory
    - COPY html /var/www/html
  - copy files
    - COPY index.html contact.html /var/www/html/
  ADD src dst 
  - like COPY but can extract tar files and put each in its path
  - can also ADD remote URLs
  ENV key value
  - Set environment variable
  ARG: <variable[=<default value>]
  - Build argument <variable[=<default value>] (p.59)
  USER <uid>|<uname>
  - Start up user
  WORKDIR /var/www/html
  - Change the working directory. Will create the path it not exist
  VOLUME ["/mnt/data", "/var/log/html"]
  VOLUME /mnt/data
  - creates a dir which can be used to mount volumes from the host or other containers
  - can be an array of paths or a single mountpoint
  EXPOSE 53/udp 8080
  - open network port
  LABEL version="2.0"
        release="20180805"
  - add key/value pairs as metadata to your container
  - label schema to avoid conflicts.. see p.63
  RUN cmd arg1 arg2 ...
    - RUN commands run at build time
    - uses /bin/sh -c
    - Best practice to RUN all commands with one RUN
    - Can use json array type
      - RUN ["bash", "-c", "rm", "-rf", "/tmp/asdf"]
    - Install apache2 package
      - RUN apt update && \
            apt install -y apapch2 && \
            apt-get clean
  CMD cmd
    - CMD commands are run when the container is launched
    - Only the last CMD will be run
    - executed using /bin/sh -c
  ENTRYPOINT cmd
    - application to run, once the application terminates the container terminiates
    - see p. 68
  HEALTHCHECK [options] CMD <command>
    - the command is run every 30 seconds by default
    - if command has exit code 0 then healthy, exit code 1 then unhealthy
    - options: --interval=30s, --timeout=30s, --retries=3
    - Example:
        HEALTHCHECK --interval=5m --timeout=3s
          CMD curl -f http://localhost/ || exit 1
    - Turn off healthcheck
        HEALTHCHECK NONE
  ONBUILD
  STOPSIGNAL
  SHELL ["<shell>", "arg-1", "arg-n"]
  - change the default shell

### .dockerignor
Exclude directories and files

  .git
  *.tmp

### Docker Image management
You can view the layers implemented on an image with

  docker history IMAGE_NAME

### Dockerfile Best Practices
https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

--------------------------------------------------
Chap 4
==================================================
## 4. Publishing Images
Reveiw quickly

Create an account on docker hub
Build and commit your container
Login to docker hub

    docker login

push your image

    docker push shortrope/ubuutils

--------------------------------------------------
Chap 5
==================================================
## 5. Private Docker infrastructure

### Docker Registry
Tcp port 5000
Storage degault path: /var/lib/registry

    docker run -d -p 5000:5000 --restart=always --name registry registry:2

Test the Registry

    docker pull hello-world
    docker tag hello-world localhost:5000/hello-world
    docker images
    docker push localhost:5000/hello-world
    docker rmi localhost:5000/hello-world
    docker pull localhost:5000/hello-world

    docker stop registry 
    docker rm -v registry

Create with Storage

    docker run -d -p 5000:5000 --restart=always --name registry -v `pwd`/data:/var/lib/registry registry:2

With SSL certificates: p.105
Starting w Docker Compose p.108

### Webhook notifications 
p.110

### Registry HTTP API 
p.111
https://github.com/docker/distribution/blob/master/docs/spec/api.md.



--------------------------------------------------
Chap 6
==================================================
## 6. Running Services in a Container

### Container Networking
docker network ls
docker network create
docker network connect
docker network disconnect
docker network inspect
docker network rm

3 Networks exist by default

    bridge
    host    # shares the host IP address and ports
    none    # lo only

Other networks available

    overlay
    macvlan
    ipvlan

A container attaches to 'bridge' by default
Attach a container to a network 

    --net=none
    docker run --net=host

Inspect the network

    docker network inspect id|name

Inspect the IP address of a container

    docker inspect id|name
    docker inspect --format='{{.NetworkSettings.IPAddress}}' id|name

### CaaS (Container as a service) Exposing and connecting to container services

### Publishing a containers port
    -p
    <hostPort>:<containerPort>
    <containerPort>
    <ip>:<hostPort>:<containerPort>
    <ip>::<containerPort>

    docker run -d -p 80:80 apache2

__This did not work!! Could not connect to the web service!__
Resolved: the container was running in an antlet. I was trying to connect from
my local LAN. Works from another antlet (Win). 
Need to create a bridged NIC

#### NAT for containers
When a port is mapped to a container, docker automatically creates an iptables rule

    iptables -t nat -L -n


#### Show the container port

    docker ps
    docker port id|name
    docker inspect id|name

There are several places in the insplet json which displays the port

    docker inspect --format='{{.ExposedPorts}}' id|name

### Binding a specific IP address
By default containers get bound to all interfaces on the host machine - 0.0.0.0
To use a specific IP address

    docker run -d -p x.x.x:x:x id|name
    docker run -d -p 192.168.1.73:80:80 apache2

This must be an address on the host machine. 

### Autogenerate Docker Host Port
If you need to start multiple containers with the same service, you can let docker
autogenerate a port mapping

    docker run -d -p 80 apache2
    docker run -d -p 192.168.1.73::80 apache2

Verify with

    docker ps
    docker inspect id|name
    iptables -t nat -L -n

### Port Binding w EXPOSE and -P
Gives the ability to embed the port details in the image so you can easily find
the port details.

Use the EXPOSE directive in the Dockerfile for building an image

    FROM ubuntu:18.04
    MAINTAINER Dr. Mario Kaack <mario@kaack.com>
    RUN apt update && apt install -y apache2 && apt clean
    EXPOSE 80
    ENTRYPOINT ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]

Build the image

    docker build -t myapache2 .

Now you can inspect the image and look for the 'ExposedPorts' field fo 'Config

    docker inspect myapache2
    docker inspect --format='{{.Config.ExposedPorts}}' myapache2

Use -P in the 'docker run' command to autogenerate port bindings to those ports
declared with EXPOSE.

    docker run -d -P myapache2

You cannot fine tune the bindings with the -P option.. it takes no arguments
But you can still use the -p option if needed.


--------------------------------------------------
Chap 7
==================================================
## 7. Sharing Data with Containers

### **Data Volume**
A Data Volume is a part of the Docker Host file system that gets mounted inside
the container The Data Volume is not part of the container file system

    /var/lib/docker/volumes/`<id>`/_data/  

You can create a Volume with a Docker file or with the docker run -v option

    FROM ubuntu:16.04
    VOLUME /mountpointdemo
or

    docker run -v /mountpointdemo

You can look for Volume info in an image. If the image was created with a VOLUME in the docker file.

    docker inspect IMAGE_NAME

After starting a container from the image inspect the image with

    docker inspect -f '{{json .Mounts}}' id|name

If you rm the container the volume remains in /var/lib/docker/volumes/`<id>`/
You can remove the volume when you rm the container

    docker rm -v id|name

_**Example:**_

    FROM ubuntu:16.04
    VOLUME /mountpointdemo

Build the image

    docker build -t mountpointdemo .

Launch a container

    docker run --rm -it mountpointdemo

In the container create a file in /mountdir

    touch /mountdir/I-was-hear

Then in the host OS check

    /var/lib/docker/volumes/`<id>`/_data/  

and you will see your file.  

### **The Volume Management command**

### **Sharing Host Data**


### **Sharing Data between Containers**


### **Common Pitfalls**